pipeline {
  agent any
  
  stages {
    stage('install playwright') {
      steps {
        sh 'npm install'
                sh 'npx playwright install'
                // Explicitly create a reporter configuration file if it doesn't exist
                sh '''
                    cat > playwright.config.js << 'EOL'
                    module.exports = {
                      reporter: [
                        ['junit', { outputFile: 'junit-results.xml' }],
                        ['html']
                      ]
                    };
                    EOL
                '''
                sh 'npx playwright test'
                // Verify the file was created
                sh 'ls -la'
      }
      post {
                always {
                    junit(testResults: 'junit-results.xml', allowEmptyResults: true)
                }
            }
    }
    
  //   stage('test') {
  //     steps {
  //       sh '''
  //         npx playwright test --list
  //         npx playwright test --reporter=junit > junit-results.xml
  //       '''
  //     }
  //     post {
  //               always {
  //                   junit 'junit-results.xml'
  //               }
  //   }
  // }
  stage('Publish to Zephyr Scale') {
    steps {
        withCredentials([string(credentialsId: 'zephyr-api-token', variable: 'ZEPHYR_TOKEN')]) {
            sh """
                curl -X POST \
                -H "Authorization: Bearer ${ZEPHYR_TOKEN}" \
                -H "Content-Type: multipart/form-data" \
                -F "file=@test-results/junit-results.xml" \
                -F "projectKey=SCRUM" \
                -F "autoCreateTestCycle=true" \
                -F "testCycleName=Playwright Tests - Build ${BUILD_NUMBER}" \
                "https://api.zephyrscale.com/v1/automation/executions/junit"
            """
        }
    }
}
 }
 
}
