pipeline {
  agent any
  
  stages {
    stage('install playwright') {
      steps {
        sh '''
          npm i -D @playwright/test
          npx playwright install
        '''
      }
    }
    
    stage('test') {
      steps {
        sh '''
          npx playwright test 
          cat junit-results.xml
        '''
      }
      post {
                always {
                    junit allowEmptyResults: true, testResults: 'junit-results.xml'
                    archiveArtifacts artifacts: 'junit-results.xml', allowEmptyArchive: true
                }
    }
  }
  stage('Publish to Zephyr Scale') {
    steps {
        withCredentials([string(credentialsId: 'zephyr-api-token', variable: 'ZEPHYR_TOKEN')]) {
            sh """
                curl -v -X POST \\
                            -H "Authorization: Bearer ${ZEPHYR_TOKEN}" \\
                            -H "Content-Type: multipart/form-data" \\
                            -F "file=@playwright-reports/junit-results.xml" \\
                            -F "projectKey=SCRUM" \\
                            -F "autoCreateTestCycle=true" \\
                            -F "testCycleName=Playwright Tests - Build ${BUILD_NUMBER}" \\
                            "https://api.zephyrscale.smartbear.com/v2/automations/executions/junit"
            """
        }
    }
}
 }
 
}
