pipeline {
  agent any
  
  stages {
    stage('install playwright') {
      steps {
        sh '''
          npm i -D @playwright/test
          npx playwright install
        '''
      }
    }
    
    stage('test') {
      steps {
        sh '''
          npx playwright test 
        
        '''
      }
      post {
                always {
                    junit 'playwright-reports/junit-results.xml'
                    archiveArtifacts allowEmptyArchive: true, artifacts: 'playwright-report/**/*'
                }
    }
  }
  stage('Publish to Zephyr Scale') {
    steps {
        withCredentials([string(credentialsId: 'zephyr-api-token', variable: 'ZEPHYR_TOKEN')]) {
            sh """
                curl -X POST \
                -H "Authorization: Bearer ${ZEPHYR_TOKEN}" \
                -H "Content-Type: multipart/form-data" \
                -F "file=@test-results/junit-results.xml" \
                -F "projectKey=SCRUM" \
                -F "autoCreateTestCycle=true" \
                -F "testCycleName=Playwright Tests - Build ${BUILD_NUMBER}" \
                "https://api.zephyrscale.com/v1/automation/executions/junit"
            """
        }
    }
}
 }
 
}
