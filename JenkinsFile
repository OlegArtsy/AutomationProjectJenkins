pipeline {
    agent any
    
    tools {
        nodejs 'Node16'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'npm ci'
                sh 'npx playwright install --with-deps'
            }
        }
        
        stage('Run Tests') {
            steps {
                sh 'npx playwright test'
            }
            post {
                always {
                    junit 'test-results/junit-report.xml'
                    archiveArtifacts(
                        artifacts: 'test-results/**/*.png, playwright-report/**/*.png',
                        allowEmptyArchive: true
                    )
                }
            }
        }
        
        stage('Publish to Zephyr Scale') {
            steps {
                zephyrScale(
                    projectKey: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjb250ZXh0Ijp7ImJhc2VVcmwiOiJodHRwczovL2FydHN5YmFzaGV2b2xlZy5hdGxhc3NpYW4ubmV0IiwidXNlciI6eyJhY2NvdW50SWQiOiI1NTcwNTg6NzRhOWJkZTMtMjAwMi00MTI2LWFiNDAtZTljYTJkN2FhNzYwIiwidG9rZW5JZCI6IjhiNjY1MTA2LTc2YTAtNGVhNy1iNGY3LWJjODg2ZDljZGY0OSJ9fSwiaXNzIjoiY29tLmthbm9haC50ZXN0LW1hbmFnZXIiLCJzdWIiOiIxZDNlYmMzMC04MjMxLTM1MGMtYTJjOC0wNTczOTk1MWM5ZWMiLCJleHAiOjE3NzIxNjY4MzcsImlhdCI6MTc0MDYzMDgzN30.j_raZMxr55RddCSaP0234JHMFBPAof4COBSNplflqC4',
                    testCycle: [
                        name: "Playwright Automated Tests - ${BUILD_NUMBER}",
                        description: "Automated tests run on ${BUILD_TIMESTAMP}"
                    ],
                    jiraInstance: 'your-jira-instance', // This should match your Jenkins configuration
                    resultsFormat: 'junit',
                    resultsFile: 'test-results/junit-report.xml',
                    serverAddress: 'https://your-jira-instance.atlassian.net', // Use your Jira URL
                    autoCreateTestCases: true // Set to false if you want to manually create test cases in Zephyr
                )
            }
        }
    }
}